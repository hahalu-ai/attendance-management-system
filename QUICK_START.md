# Quick Start Guide - Three-Tier System

## For Railway Deployment

### Step 1: Deploy to Railway (First Time)

1. **Push your code to GitHub** (if not already done)

2. **Create Railway Project**
   - Go to https://railway.app
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Choose your repository

3. **Add MySQL Database**
   - Click "+ New" → "Database" → "Add MySQL"
   - Railway will automatically create and link the database

4. **Set Environment Variables**

   Go to your service → Variables tab and add:
   ```
   PORT=5001
   SECRET_KEY=your-secret-key-here
   ```

   Database variables are automatically set by Railway!

5. **Update Start Command**

   In Settings → Deploy:
   ```bash
   python backend/migrate_to_three_tier.py && python backend/run.py
   ```

   This runs the migration THEN starts the server!

6. **Deploy!**
   - Railway will auto-deploy
   - Migration runs automatically on first deployment

### Step 2: Verify Migration

Check the deployment logs to see migration output:
- Look for "✅ MIGRATION COMPLETED SUCCESSFULLY!"
- If you see errors, check the database connection

### Step 3: Test the System

1. **Access your frontend URL**: `https://your-project.up.railway.app`

2. **Create your first Lead**:
   - Login as Manager (if you have one, or create via register page)
   - Go to User Management → Create New User
   - Select "Lead" as user level
   - Fill in details and create

3. **Lead creates Members**:
   - Login as the Lead you just created
   - Go to "Manage Members" tab
   - Click "Add New Member"
   - Fill in details (no password needed for Members!)

4. **Generate QR Code**:
   - As Lead, go to "QR Check-in/out" tab
   - Select a Member
   - Click "Generate Check-in QR Code"

5. **Member Scans QR**:
   - Open QR Scanner page on mobile: `your-url/worker/scan.html`
   - Allow camera access
   - Scan the QR code generated by Lead
   - Check-in should be auto-approved!

## Local Development

### Step 1: Setup Database

```bash
# Start MySQL
mysql -u root -p

# In MySQL:
CREATE DATABASE attendance_system;
EXIT;
```

### Step 2: Run Migration

```bash
cd backend
python migrate_to_three_tier.py
```

### Step 3: Start Backend

```bash
cd backend
python run.py
```

### Step 4: Start Frontend

```bash
cd frontend
python -m http.server 8080
```

Visit: http://localhost:8080

## Updating Railway Deployment

### If you already have the old system deployed:

1. **Update your code** on GitHub

2. **Migration runs automatically** on next deploy (it's idempotent - safe to run multiple times!)

3. **If migration doesn't auto-run**, manually trigger via Railway CLI:
   ```bash
   railway run python backend/migrate_to_three_tier.py
   ```

## System Architecture

```
Manager (Super-User)
  ├─ Can create/manage Leads
  ├─ Can view ALL Leads and Members
  └─ Can approve any attendance entry

Lead
  ├─ Can create/manage Members (their team)
  ├─ Can generate QR codes for Members
  ├─ Can approve their Members' attendance
  └─ Has username & password (can login)

Member
  ├─ NO login (QR code only)
  ├─ NO dashboard access
  ├─ Scans QR codes to check-in/out
  └─ Assigned to exactly ONE Lead
```

## API Endpoints Quick Reference

**Authentication:**
- `POST /api/auth/login` - Manager/Lead login (Members cannot login)

**Manager:**
- `GET /api/users/manager/{username}/leads` - Get all Leads
- `GET /api/users/manager/{username}/all-members` - Get all Members
- `POST /api/users/` - Create Lead (set `user_level: "Lead"`)

**Lead:**
- `GET /api/users/lead/{username}/members` - Get my Members
- `POST /api/users/lead/{username}/members` - Create new Member
- `DELETE /api/users/lead/{username}/members/{member}` - Remove Member
- `POST /api/attendance/qr/generate` - Generate QR code for Member

**QR Code:**
- `POST /api/attendance/qr/verify` - Member scans QR to check-in/out

**Approvals:**
- `GET /api/attendance/pending-approvals?username={approver}` - Get pending (Manager sees all, Lead sees their Members)
- `POST /api/attendance/approve` - Approve/reject entry

## Troubleshooting

### "Migration already completed"
✅ This is normal! The script is idempotent and safe to run multiple times.

### "Only Leads can generate QR codes"
✅ Correct behavior! Managers no longer generate QR codes - only Leads do.

### "Members cannot log in"
✅ Correct behavior! Members don't have passwords and can't login. They only use QR codes.

### Frontend shows old "Contractor" terminology
❌ Clear your browser cache or do a hard refresh (Ctrl+F5 / Cmd+Shift+R)

### Can't connect to database on Railway
- Check environment variables are set correctly
- Verify MySQL service is running
- Check connection string format

## Support

- Check `MIGRATION_GUIDE.md` for detailed migration info
- Check `RAILWAY_DEPLOYMENT.md` for Railway-specific instructions
- View deployment logs in Railway dashboard
- Check backend logs for API errors

## Testing Checklist

After deployment, test:
- [ ] Manager can login
- [ ] Manager can create Leads
- [ ] Lead can login
- [ ] Lead can create Members
- [ ] Lead can generate QR codes
- [ ] Members can scan QR codes
- [ ] Check-in via QR is auto-approved
- [ ] Lead can view pending approvals
- [ ] Manager can view all system data

---

**Version**: 3.0
**Last Updated**: 2026-01-08
