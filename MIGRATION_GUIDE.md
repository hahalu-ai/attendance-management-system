# Migration Guide: Two-Tier to Three-Tier User System

## Overview

This migration transforms your attendance management system from a two-tier structure (Manager, Contractor) to a three-tier structure (Manager, Lead, Member).

### New User Roles

1. **Manager** (Super-User)
   - Full system access
   - Can create and manage Leads
   - Can view all Leads and their Members
   - Can view all attendance data across the system

2. **Lead**
   - Has username and password (can log in)
   - Can create and manage Members
   - Generate QR codes for their Members to check-in/checkout
   - View dashboard showing all their Members' attendance
   - Approve/reject their Members' time entries

3. **Member**
   - No login credentials (QR code only)
   - No dashboard access
   - Only check-in/checkout via QR codes generated by their Lead
   - Assigned to exactly one Lead

## Database Migration

### Step 1: Backup Your Database

**CRITICAL: Backup your database before proceeding!**

```bash
# Backup the entire database
mysqldump -u root -p attendance_system > backup_attendance_system_$(date +%Y%m%d).sql

# Or backup specific tables
mysqldump -u root -p attendance_system users manager_assignments time_entries qr_requests > backup_tables_$(date +%Y%m%d).sql
```

### Step 2: Run the Migration Script

```bash
# Login to MySQL
mysql -u root -p

# Switch to your database
USE attendance_system;

# Run the migration script
SOURCE backend/database/migration_to_three_tiers.sql;
```

### Step 3: Verify the Migration

```sql
-- Check user types
SELECT user_level, COUNT(*) as count FROM users GROUP BY user_level;

-- Expected output:
-- user_level | count
-- -----------|------
-- Manager    |   X
-- Lead       |   Y
-- Member     |   0    (will be created by Leads)

-- View Manager-Lead relationships
SELECT mla.manager_username, u1.display_name as manager_name,
       mla.lead_username, u2.display_name as lead_name
FROM manager_lead_assignments mla
JOIN users u1 ON mla.manager_username = u1.username
JOIN users u2 ON mla.lead_username = u2.username;

-- View Lead-Member relationships (empty initially)
SELECT la.lead_username, u1.display_name as lead_name,
       la.member_username, u2.display_name as member_name
FROM lead_assignments la
JOIN users u1 ON la.lead_username = u1.username
JOIN users u2 ON la.member_username = u2.username;
```

## Backend Changes

### API Endpoint Changes

#### Authentication (auth.py)
- **No URL changes**
- Members cannot log in (will get 403 error)
- Registration now supports 'Member' user level (no password required)

#### Users API (users.py) - NEW ENDPOINTS

**Manager Endpoints:**
```bash
GET /api/users/manager/{username}/leads
# Get all Leads (Managers see ALL Leads)

GET /api/users/manager/{username}/all-members
# Get all Members across all Leads
```

**Lead Endpoints:**
```bash
GET /api/users/lead/{username}/members
# Get Members assigned to this Lead

POST /api/users/lead/{username}/members
# Lead creates a new Member
# Body: {
#   "member_username": "member01",
#   "display_name": "John Doe",
#   "email": "john@example.com"
# }

DELETE /api/users/lead/{username}/members/{member_username}
# Lead removes a Member from their team
```

**General Endpoints:**
```bash
POST /api/users/assign-lead-to-manager
# Assign a Lead to a Manager (for tracking)
# Body: {
#   "manager_username": "manager01",
#   "lead_username": "lead01"
# }

POST /api/users/assign-member-to-lead
# Assign an existing Member to a Lead
# Body: {
#   "lead_username": "lead01",
#   "member_username": "member01"
# }
```

#### Attendance API (attendance.py) - UPDATED

**QR Code Generation (IMPORTANT CHANGE!):**
```bash
POST /api/attendance/qr/generate
# Now ONLY Leads can generate QR codes (not Managers)
# Body: {
#   "lead_username": "lead01",      # Changed from manager_username
#   "member_username": "member01",  # Changed from worker_username
#   "action": "check-in"            # or "check-out"
# }
```

**QR Code Verification:**
```bash
POST /api/attendance/qr/verify
# Members scan to check-in/checkout
# Body: {
#   "token": "abc123...",
#   "member_username": "member01"  # Changed from worker_username
# }
```

**Pending Approvals:**
```bash
GET /api/attendance/pending-approvals?username=lead01
# Changed from manager_username to username
# Managers see ALL pending entries
# Leads see only their Members' pending entries
```

**Approve Entry:**
```bash
POST /api/attendance/approve
# Body: {
#   "approver_username": "lead01",  # Changed from manager_username
#   "entry_id": 123,
#   "status": "Approved",
#   "notes": "..."
# }
```

## Frontend Changes Needed

### 1. Update Login Page
- Add check to prevent Members from accessing login page
- Show appropriate error message

### 2. Create Lead Dashboard (`frontend/lead/portal.html`)
- Similar to Manager portal but with limited scope
- Show only their own Members
- Generate QR codes for their Members
- View/approve their Members' attendance

**Key Features:**
- Member list (add/remove)
- QR code generation interface
- Pending approvals list (only their Members)
- Member attendance view

### 3. Update Manager Dashboard
- Replace "Contractors" with "Leads"
- Show all Leads in the system
- View network under each Lead
- View all attendance data

**Key Features:**
- Lead management (create/delete Leads)
- View all Leads and their Members (hierarchical view)
- System-wide attendance reports

### 4. Remove Member Dashboard Access
- Members should NOT have a dashboard
- Redirect any Member login attempts to an error page
- Members only interact via QR code scanning

### 5. Update QR Code Generation UI
- Update API calls from `manager_username` to `lead_username`
- Update API calls from `worker_username` to `member_username`

### 6. Update Terminology Throughout
- Replace "Manager" → "Manager/Lead" in UI where appropriate
- Replace "Contractor" → "Lead"
- Replace "Worker" → "Member"
- Update all form labels and buttons

## Testing Checklist

### Manager Tests
- [ ] Manager can log in
- [ ] Manager can create new Leads
- [ ] Manager can view all Leads
- [ ] Manager can view all Members across all Leads
- [ ] Manager can view all pending approvals
- [ ] Manager can approve/reject any time entry
- [ ] Manager can delete Leads (with validation)

### Lead Tests
- [ ] Lead can log in with username/password
- [ ] Lead can create new Members
- [ ] Lead can view their Members list
- [ ] Lead can delete Members from their team
- [ ] Lead can generate QR codes for their Members
- [ ] Lead can view pending approvals for their Members only
- [ ] Lead can approve/reject their Members' time entries
- [ ] Lead CANNOT create other Leads
- [ ] Lead CANNOT view Members from other Leads

### Member Tests
- [ ] Member CANNOT log in (gets appropriate error)
- [ ] Member can scan QR code for check-in
- [ ] Member can scan QR code for check-out
- [ ] QR check-in creates time entry (auto-approved)
- [ ] QR check-out updates existing time entry
- [ ] Invalid QR code shows error
- [ ] Expired QR code shows error

### API Tests

```bash
# Test Manager creating a Lead
curl -X POST http://localhost:5001/api/users/ \
  -H "Content-Type: application/json" \
  -d '{
    "requester_username": "ylin",
    "username": "lead01",
    "display_name": "Lead One",
    "email": "lead01@example.com",
    "password": "password123",
    "user_level": "Lead"
  }'

# Test Lead creating a Member
curl -X POST http://localhost:5001/api/users/lead/lead01/members \
  -H "Content-Type: application/json" \
  -d '{
    "member_username": "member01",
    "display_name": "Member One",
    "email": "member01@example.com"
  }'

# Test Lead generating QR code
curl -X POST http://localhost:5001/api/attendance/qr/generate \
  -H "Content-Type: application/json" \
  -d '{
    "lead_username": "lead01",
    "member_username": "member01",
    "action": "check-in"
  }'

# Test Lead viewing their Members
curl http://localhost:5001/api/users/lead/lead01/members

# Test Manager viewing all Leads
curl http://localhost:5001/api/users/manager/ylin/leads
```

## Rollback Plan

If something goes wrong, you can rollback using your backup:

```bash
# Stop the backend server first

# Drop the current database
mysql -u root -p -e "DROP DATABASE attendance_system;"

# Recreate the database
mysql -u root -p -e "CREATE DATABASE attendance_system;"

# Restore from backup
mysql -u root -p attendance_system < backup_attendance_system_YYYYMMDD.sql

# Restart the backend server
```

## Known Issues and Limitations

1. **Member Login**: Members do not have passwords, so they cannot log in to view their attendance history. If you want Members to view their own history, you'll need to either:
   - Add a separate member portal with token-based access
   - Allow Members to log in with a password (update the registration logic)

2. **Member Reassignment**: Members can only be assigned to one Lead. If you need to reassign a Member to a different Lead, you must:
   - Remove them from the current Lead
   - Assign them to the new Lead

3. **Orphaned Members**: If you delete a Member's assignment without deleting the Member user, they become orphaned. The migration script keeps the Member user in the database. You may want to add logic to auto-delete orphaned Members.

## Support

If you encounter issues during migration:

1. Check the MySQL error log: `/var/log/mysql/error.log`
2. Check the backend logs when running: `python run.py`
3. Verify your database credentials in `backend/app/config.py`
4. Ensure all foreign key constraints are satisfied

## Next Steps

1. Run the database migration
2. Test the backend API endpoints
3. Update the frontend (detailed guide in FRONTEND_UPDATES.md)
4. Test the complete workflow
5. Deploy to production

---

**Last Updated**: 2026-01-08
**Version**: 3.0
